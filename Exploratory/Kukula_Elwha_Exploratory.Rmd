---
title: "Kukula_Elwha_Exploratory"
author: "Kaitlyn Kukula"
date: "`r Sys.Date()`"
output: pdf_document
editor_options: 
  chunk_output_type: console
---

## Other datasest
dataset catalog - https://catalog.data.gov/dataset/?q=elwha&sort=views_recent+desc&publisher=U.S.+Geological+Survey&ext_location=&ext_bbox=&ext_prev_extent=&tags=elwha-river

river topography -https://catalog.data.gov/dataset/river-channel-topography-on-the-elwha-river-washington-2006-to-2022-ver-2-0-july-2025
dem - https://catalog.data.gov/dataset/digital-elevation-models-dems-of-the-elwha-river-delta-washington-august-2022
veg data (promising) - https://catalog.data.gov/dataset/vascular-plant-diversity-and-associated-environmental-variables-along-the-elwha-river-2005
daily sediment from old usgs station - https://catalog.data.gov/dataset/daily-sediment-loads-during-and-after-dam-removal-in-the-elwha-river-washington-2011-to-20

## NOTES

# Timeline of dam removal:

Elwha Dam: draw-down began June 1, 2011, construction Sept 19, 2011 - March 2012
Glines Canyon Dam: draw-down began ???, construction Sept 2011 - August 26, 2014

Elwha HUC watershed 17110020 (PNW region, Puget Sound subregion, Puget Sound basin, Dungeness-Elwha subbasin, 1635 sq.mi.)

The goal of this study is to perform a general review of coastal organisms following the removal of two dams from the Elwha River in Washington. Some interesting questions to consider could be the use of eDNA for tracking fish movements or determining food chain transformations. 

USGS Report (PDF in folder): chrome-extension://efaidnbmnnnibpcajpcglclefindmkaj/https://pubs.usgs.gov/sir/2011/5120/pdf/sir20115120.pdf

A general structure of the study could include:
1. System analysis: streamflow at available USGS gage site, estuary sediment transport
2. Comparing water quality metrics before and after dam removal
   Literature review may be required to put these values in context
3. Mapping and comparing species distribution/abundance before and after dam removal
4. Mapping and comparing eDNA and species distribution/abundance

Available data:
- eDNA shedding from live and dead fish
- Estuarian fish
- Estuarian riparian veg abundance
- Estuarian riparian veg richness
- Estuarian sediment
- Estuarian WQ
- eDNA post-removal

Data we need to gather or find:
- USGS Gage Station #12045500
- USGS Gage Station #12044900
- Watershed spatial data

Some maps I think would be useful:
Map 1. Elwha River watershed including major tributaries, dams, USGS monitoring stations, and an inset map showing the general location in Washington
Map 2-n. Sample collection sites for organism studies. This could be an interactive map.
Map n+1: Might be interested in showing the spatial species distributions if we find anything of note? This could be an interactive map. 

Some figures I think would be useful:
- Streamflow at both sites as a function of time
- Species comparisons before and after dam removal

```{r}
library(ggplot2)
library(tidyverse)
library(here)
library(lubridate)
library(cowplot)

here()

kak_theme <- theme_classic() +
  theme(plot.title = element_text(size = 11, hjust = 0.5, face = "bold"), #Adjust title
        axis.text.x = element_text(size = 9), # Adjust x-axis values
        axis.text.y = element_text(size = 9), # Adjust y-axis values
        axis.title.x = element_text(size = 10.5, face = "bold"), # Adjust x-axis title
        axis.title.y = element_text(size = 10.5, face = "bold"), # Adjust y-axis title
        legend.position = "bottom", # Define legend position
        legend.text = element_text(size = 9), # Define legend entry sizes
        legend.title = element_text(size = 9)) # Define legend name sizes
set_theme(kak_theme)
```

## Daily streamflow for Elwha River at McDonald Bridge near Port Angeles, WA

# Continuous median daily gage height (ft) at 12045500 
https://waterservices.usgs.gov/nwis/iv/?sites=12045500&agencyCd=USGS&startDT=2025-11-06T11:24:16.160-08:00&endDT=2025-11-13T11:24:16.160-08:00&parameterCd=00065&format=rdb

```{r warning=FALSE}

### USGS Gage Data Scraping and Plotting
# Gage data scraped from the USGS website for site #12045500 (Elwha River at McDonald
# Bridge near Port Angeles, WA). Datapoints recorded every 15 minutes.

# Define date range
gage_start = '2007-01-01'
gage_end = '2017-01-01'

#Set the URLs
elwha_gage_url <- paste0('https://waterservices.usgs.gov/nwis/iv/?sites=12045500&agencyCd=USGS&startDT=', 
                         gage_start,
                         'T11:24:16.160-08:00&endDT=',
                         gage_end, 
                         'T11:24:16.160-08:00&parameterCd=00065&format=rdb')

#Get the data
gage_data_elwha_init <- read.table(elwha_gage_url, skip = 28, header=TRUE,
                                   sep='\t', stringsAsFactors = T) 

#Update the column headers
colnames(gage_data_elwha_init) = c("agency_cd", "site_no", "datetime", "tz_cd",
                                   "gage_ht_ft", "150691_00060_cd")

#Tidy the data
gage_data_elwha <- gage_data_elwha_init %>% 
  select(datetime, gage_ht_ft) %>% 
  mutate(datetime = ymd_hm(datetime))

#Plot
# Set rectangle measurements
gage_elwha_dam_timeline <- data.frame(
  xmin = as.POSIXct("2011-06-01 01:15:00", tz = "UTC"),
  xmax = as.POSIXct("2012-03-01 01:15:00", tz = "UTC"),
  ymin = 10, ymax = 25) # Note that this start date includes the drawdown period.
gage_glines_dam_timeline <- data.frame(
  xmin = as.POSIXct("2011-09-19 01:15:00", tz = "UTC"),
  xmax = as.POSIXct("2014-08-26 01:15:00", tz = "UTC"),
  ymin = 10, ymax = 25)

gage_elwha_plot <- ggplot() +
  geom_rect(data = gage_elwha_dam_timeline,
            aes(xmin = xmin, xmax = xmax,
                ymin = ymin, ymax = ymax),
            fill = "#7cae00", alpha = 0.5) +
  geom_rect(data = gage_glines_dam_timeline,
            aes(xmin = xmin, xmax = xmax,
                ymin = ymin, ymax = ymax),
            fill = "#00a9af", alpha = 0.25) +
  geom_line(data = gage_data_elwha, aes(x=datetime, y=gage_ht_ft)) +
  labs(x = NULL,
       y = "Gage height [ft]",
       title = "Elwha River at McDonald Bridge Gage Height (2007 - 2017)") +
  scale_fill_manual(values = c("Elwha", "Glines"),
                    labels = c("Elwha Dam Removal", "Glines Canyon Dam removal")) +
  theme(legend.position = "bottom")
gage_elwha_plot

```
            
# Continuous median daily discharge (ft3/s) at 12045500
https://nwis.waterservices.usgs.gov/nwis/iv/?sites=12045500&agencyCd=USGS&startDT=2024-11-13T11:20:31.677-08:00&endDT=2025-11-13T11:20:31.677-08:00&parameterCd=00060&format=rdb

```{r warning=FALSE}

### USGS discharge data scraping and plotting
# Discharge data scraped from the USGS website for site #12045500 (Elwha River at McDonald
# Bridge near Port Angeles, WA). Datapoints recorded every 15 minutes.

# Define date range
discharge_start = '2007-01-01'
discharge_end = '2017-12-31'

#Set the URLs
elwha_discharge_url <- paste0('https://nwis.waterservices.usgs.gov/nwis/iv/?sites=12045500&agencyCd=USGS&startDT=',
                         discharge_start,
                         'T11:20:31.677-08:00&endDT=',
                         discharge_end, 
                         'T11:20:31.677-08:00&parameterCd=00060&format=rdb')

#Get the data
discharge_data_elwha_init <- read.table(elwha_discharge_url, skip = 30, header=TRUE,
                                        sep='\t', stringsAsFactors = T) 

#Update the column headers
colnames(discharge_data_elwha_init) = c("agency_cd", "site_no", "datetime", "tz_cd",
                                        "discharge_ft3s", "150691_00060_cd")

#Tidy the data
discharge_data_elwha <- discharge_data_elwha_init %>% 
  select(datetime, discharge_ft3s) %>% 
  mutate(datetime = ymd_hm(datetime))

#Plot
dis_elwha_dam_timeline <- data.frame(
  xmin = as.POSIXct("2011-06-01 01:15:00", tz = "UTC"),
  xmax = as.POSIXct("2012-03-01 01:15:00", tz = "UTC"),
  ymin = 0, ymax = 38000) # Note that this start date includes the drawdown period.
dis_glines_dam_timeline <- data.frame(
  xmin = as.POSIXct("2011-09-19 01:15:00", tz = "UTC"),
  xmax = as.POSIXct("2014-08-26 01:15:00", tz = "UTC"),
  ymin = 10, ymax = 38000)

discharge_elwha_plot <- ggplot() +
  geom_rect(data = dis_elwha_dam_timeline,
            aes(xmin = xmin, xmax = xmax,
                ymin = ymin, ymax = ymax),
            fill = "#7cae00", alpha = 0.5) +
  geom_rect(data = dis_glines_dam_timeline,
            aes(xmin = xmin, xmax = xmax,
                ymin = ymin, ymax = ymax),
            fill = "#00a9af", alpha = 0.25) +
  geom_line(data = discharge_data_elwha, aes(x=datetime, y=discharge_ft3s)) +
  labs(x = NULL,
       y = "Discharge [ft3/s]",
       title = "Elwha River at McDonald Bridge Discharge (2007 - 2017)") +
  scale_fill_manual(values = c("Elwha", "Glines"),
                    labels = c("Elwha Dam Removal", "Glines Canyon Dam removal")) +
  theme(legend.position = "bottom")
discharge_elwha_plot
```

```{r fig.cap="Daily streamflow measurements of Elwha River at McDonald Bridge near Port Angeles, WA from 2007 - 2017}

# Still need to make the axis be the same length, add a title and make what are currently the titles subtitles, and figure out where the legend isnt working!!!!!!!!! Also figure out why the discharge values are different from the ones in the downloaded file..... might need to just redo the average discharge plot with the scraped data and double check it with the USGS report to ensure the values are roughly the same because the scraped data has 2x different values........


plot_grid(gage_elwha_plot, discharge_elwha_plot,
          nrow = 2)
```

```{r fig.cap = "Daily Discharge of the Elwha River from 2011 - 2020 (gage station 12045500)"}

discharge_12045500_raw <- read.csv(here("Data/Raw/daily_discharge_ 12045500.csv"))
discharge_12045500 <- discharge_12045500_raw %>%
  mutate(time = mdy(time),
         value = as.numeric(value),
         day = day(time), 
         month = month(time),
         year = year(time)) 

# Plotting the daily discharge data from 2011 to 2020

ggplot(data = discharge_12045500 %>% filter(year > 2006 & year < 2020)) +
  geom_line(aes(x = time,y = value))

```

```{r fig.cap = "Mean Monthly Discharge of the Elwha River from 1998 - 2024 (gage station 12045500)"}

# Calculating the discharge over a set of years

year_start = 1998
year_end = 2024
discharge_12045500_mean <- discharge_12045500 %>%
  group_by(month) %>%
  filter(year > year_start & year < year_end) %>%
  summarise(mean_discharge = mean(value),
            min_discharge = min(value),
            max_discharge = max(value),
            q25_discharge = quantile(value, 0.25),
            q75_discharge = quantile(value, 0.75))

# Plotting discharge

ggplot(discharge_12045500_mean) +
  geom_point(aes(x = month, y = mean_discharge)) +
  geom_line(aes(x = month, y = mean_discharge)) +
  labs(x = "Month",
       y = "Discharge [ft^3/s]") +
  scale_x_continuous(breaks = 1:12, 
                     labels = month.abb) +
  scale_y_continuous(breaks=seq(0,3000,500)) +
  geom_errorbar(aes(x = month,
                    y = mean_discharge,
                    ymin = q25_discharge,
                    ymax = q75_discharge),
                width = 0.2)
```

## Is there a connection between invert abundance, salmon populations, and salmon diet in the Elwha River?

Data wrangling plot that would be helpful is one of those stacked bar/point plots that tells you when stuff was sampled or like one of those timelines that we used to show when animals were dosed but instead of doses its the sampling time

# Estuary Invertebrates

This data set contains observations of 20 estuary invertebrate species at three sites for one timepoint before and one timepoint after the dam removal.
Dates of observations:  May, July, Sept 2007 and 2015

```{r}
inverts_raw <- read.csv(here("Data/Raw/Elwha_Estuary_Invertabrates/Elwha_estuary_aquatic_invertebrates_2007-2013.csv")) 
inverts <- inverts_raw %>%
  mutate(Date = mdy(Date))

colnames(inverts_raw)
unique(inverts_raw$Date)
unique(inverts_raw$Site)
```

# Estuary Fish Assemblages
Dates of observations: May - Sept of 2006, 2007, 2013, and 2014
Month vs count with each line representing a year and each plot representing a species

```{r}
estuary_fish_raw <- read.csv("~/KukulaHipp/Data/Raw/Elwha_Estuary_Fish/Elwha estuary_fish_2006to2014.csv") %>%
  mutate(Date = mdy(Date.collected),
         Year = as.factor(Year.collected))
unique(estuary_fish_raw$Date)

# Select species of interest for a new dataframe at the Eastern site (species with few or no counts omitted from analysis)

estuary_fish <- estuary_fish_raw %>%
  filter(Site == "East") %>%
  select(Site, Month.collected, Chinook.salmon:Cottid.sp., Staghorn.sculpin:Three.spined.stickleback, Date:Year) %>%
  relocate(Date)

ggplot(estuary_fish %>% filter(year(Date) < "2008")) +
  geom_point(aes(x = month(Date), y = Coho.salmon, color = Year)) +
  geom_line(aes(x = month(Date), y = Coho.salmon, color = Year))

ggplot(estuary_fish %>% filter(year(Date) > "2008")) +
  geom_point(aes(x = month(Date), y = Coho.salmon, color = Year)) +
  geom_line(aes(x = month(Date), y = Coho.salmon, color = Year))
```

# Salmonid distribution and abundance 

Dates of observations: 2007, 2008, 2018, 2019
Could do some sort of bubble map with this dataset to show where more fish are getting to.
Remove columns that have limited data

```{r}
salmonid_raw <- read.csv("~/KukulaHipp/Data/Raw/Elwha_Salmon_Movement/Elwha_Riverscape_reach_data.csv") %>%
  mutate(Date = mdy(Date))


unique(salmonid_raw$Year)
```

# Salmon diet

```{r}
salmonid_diet_raw <- read.csv("~/KukulaHipp/Data/Raw/Elwha_estuary_fish_diet/Elwha_estuary_fish_diet.csv") %>%
  mutate(Date = mdy(Date),
         Year = as.numeric(Year)) %>% 
  janitor::clean_names()

# Summed all taxa consumed by salmon type in a year
diet_totals <- salmonid_diet_raw %>%
  group_by(year, fish) %>% 
  summarise(across(c(acari_larva:trichoptera_pupa), ~sum(., na.rm = TRUE))) %>% 
  ungroup() %>% 
  pivot_longer(c(acari_larva:trichoptera_pupa)) %>%
  pivot_wider(id_cols = c("fish", "name"),
              names_from = "year",
              values_from = "value",
              names_prefix = "value_") %>% 
  mutate(taxa = str_extract(name, "^.+\\_") %>% str_remove_all("\\_")) %>% 
  group_by(fish, taxa) %>% 
  summarise(across(c(value_2006:value_2014), ~sum(., na.rm = TRUE))) %>% 
  ungroup()

# Create a summary table of the number of fish sampled each year
fish_surveyed_diet <- salmonid_diet_raw %>% 
  group_by(year, fish) %>% 
  summarise(count())

  
# Dataset for Chinook salmon diet
chinook_diet <- diet_totals %>% filter(fish == "Chinook")

# Dataset for Coho salmon diet
coho_diet <- diet_totals %>% filter(fish == "Coho")

# Dataset for diet of all salmon species surveyed
all_salmon_diet <- diet_totals %>%
  group_by(taxa) %>%
  summarise(across(c(value_2006:value_2014), ~sum(., na.rm = TRUE)))


# After wrangling the invert data, use inner_join to combine with diets so you only grab similar taxa
```


## Subtidal Communities

How many species are observed at each site? Does this change over the years? What taxon (amphipods and dipterans and others - see page 187 of report) are present and how does this vary at the different sites?

```{r}
subtidal_dive_raw <- read.csv(here("Data/Raw/Elwha_Subtidal_Communities/Elwha dive site data.csv"))
unique(subtidal_dive_raw$Site)
subtidal_temp_raw <- read.csv(here("Data/Raw/Elwha_Subtidal_Communities/Elwha temperature data.csv"))
subtidal_towed_raw <- read.csv(here("Data/Raw/Elwha_Subtidal_Communities/Elwha towed video data.csv"))

```

## Estuary water quality before and after dam removal - selecting variables for individual datasets

```{r warning = FALSE}
estuary_wq_raw <- read.csv("~/KukulaHipp/Data/Raw/Elwha_Estuary_WQ/Elwha_estuary_water_quality_2006-2014.csv") %>%
  mutate(Date = mdy(Date.Collected))

# Nitrogen 
estuary_wq_nitrate <- estuary_wq_raw %>%
  mutate(Nitrate = as.numeric(Nitrate...Nitrite.concentration)) %>%
  select(Site.Name:Longitude, Nitrate, Date)

# Phosphate 
estuary_wq_phos <- estuary_wq_raw %>%
  mutate(Phosphate = as.numeric(Phosphate.concentration)) %>%
  select(Site.Name:Longitude, Phosphate, Date)

# Salinity 
estuary_wq_salinity <- estuary_wq_raw %>%
  mutate(Salinity = as.numeric(Salinity)) %>%
  select(Site.Name:Longitude, Salinity, Date)

# Temperature
estuary_wq_temperature <- estuary_wq_raw %>%
  mutate(Temperature = as.numeric(Temperature)) %>%
  select(Site.Name:Longitude, Temperature, Date)

# Dissolved oxygen
estuary_wq_do <- estuary_wq_raw %>%
  mutate(Dissolved_Oxygen = as.numeric(Dissolved.oxygen)) %>%
  select(Site.Name:Longitude, Dissolved_Oxygen, Date)

# pH
estuary_wq_ph <- estuary_wq_raw %>%
  mutate(pH = as.numeric(pH)) %>%
  select(Site.Name:Longitude, pH, Date)

# Dataset legend (grabbed from nitrate subset)
estuary_wq_legend <- get_legend(
  ggplot(estuary_wq_nitrate %>% filter(Date >= "2007-08-30")) +
  geom_point(aes(x = Date, y = Nitrate, color = Site.Name)) +
    scale_color_manual(values = c("ES1" = "#1b9e77","ES2" = "#d95f02",
                                "IEC" = "#7570b3", "WESC1" = "#e7298a",
                                "WESC2" = "#66a61e")) +
    labs(color = "Site"))

# Dataset title
dataset_title <- ggplot() + 
  labs(title = "Water Quality at the Elwha River Estuary Before and During Dam Removal",
       subtitle = "Dam removal: 2011 - 2014") +
  theme(plot.subtitle = element_text(hjust = 0.5))
```

# Nitrate

``` {r warning = FALSE, fig.cap = "Measured nitrate concentration [uM] before and after dam removal"}

# Create a before plot
nitrate_before_plot <- ggplot(estuary_wq_nitrate %>% filter(Date <= "2007-08-30")) +
  geom_point(aes(x = Date, y = Nitrate, color = Site.Name)) +
  geom_line(aes(x = Date, y = Nitrate, color = Site.Name), linewidth = 0.75) +
  scale_x_date(limits = c(as.Date("2006-06-01"), as.Date("2007-09-01")),
               breaks = "3 month", date_labels = "%b %Y") +
  ylim(c(0,20)) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position = "none") +
  labs(x = NULL, y = expression(paste("Nitrate [", mu, "M]"))) +
  scale_color_manual(values = c("ES1" = "#1b9e77", "ES2" = "#d95f02"))

# Create an after plot
nitrate_after_plot <- ggplot(estuary_wq_nitrate %>% filter(Date > "2007-08-30")) +
  geom_point(aes(x = Date, y = Nitrate, color = Site.Name)) +
  geom_line(aes(x = Date, y = Nitrate, color = Site.Name), linewidth = 0.75) +
  scale_x_date(limits = c(as.Date("2013-06-28"), as.Date("2014-10-12")),
               breaks = "3 month", date_labels = "%b %Y") +
  ylim(c(0,20)) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1), legend.position = "none") +
  labs(x = NULL, y = NULL) +
  scale_color_manual(values = c("ES1" = "#1b9e77","ES2" = "#d95f02",
                                "IEC" = "#7570b3", "WESC1" = "#e7298a",
                                "WESC2" = "#66a61e"))
# Create a legend plot
nitrate_legend <- get_legend(
  ggplot(estuary_wq_nitrate %>% filter(Date >= "2007-08-30")) +
  geom_point(aes(x = Date, y = Nitrate, color = Site.Name)) +
    scale_color_manual(values = c("ES1" = "#1b9e77","ES2" = "#d95f02",
                                "IEC" = "#7570b3", "WESC1" = "#e7298a",
                                "WESC2" = "#66a61e")) +
    labs(color = "Site"))

# Create a window for the before and after plots
nitrate_plot <- plot_grid(nitrate_before_plot, nitrate_after_plot)

# Create a window for the title
nitrate_title <- ggplot() + 
  labs(title = "Nitrate concentrations") +
  theme(plot.subtitle = element_text(hjust = 0.5))

# Generate the final plot with title, data, and legend
nitrate_plot_legend <- plot_grid(nitrate_title, nitrate_plot, nitrate_legend, 
                                 nrow = 3, rel_heights = c(0.1, 0.8, 0.1))
# Display plot
nitrate_plot_legend
```

# Phosphate

``` {r fig.cap = "Measured phosphate [units] before and after dam removal"}
# Create a before plot
phos_before_plot <- ggplot(estuary_wq_phos %>% filter(Date <= "2007-08-30")) +
  geom_point(aes(x = Date, y = Phosphate, color = Site.Name)) +
  geom_line(aes(x = Date, y = Phosphate, color = Site.Name), linewidth = 0.75) +
  scale_x_date(limits = c(as.Date("2006-06-01"), as.Date("2007-09-01")),
               breaks = "3 month", date_labels = "%b %Y") +
  ylim(c(0,0.75)) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position = "none") +
  labs(x = NULL, y = expression(paste("Phosphate [", mu, "M]"))) +
  scale_color_manual(values = c("ES1" = "#1b9e77", "ES2" = "#d95f02"))

# Create an after plot
phos_after_plot <- ggplot(estuary_wq_phos %>% filter(Date > "2007-08-30")) +
  geom_point(aes(x = Date, y = Phosphate, color = Site.Name)) +
  geom_line(aes(x = Date, y = Phosphate, color = Site.Name), linewidth = 0.75) +
  scale_x_date(limits = c(as.Date("2013-06-28"), as.Date("2014-10-12")),
               breaks = "3 month", date_labels = "%b %Y") +
  ylim(c(0,0.75)) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1), legend.position = "none") +
  labs(x = NULL, y = NULL) +
  scale_color_manual(values = c("ES1" = "#1b9e77","ES2" = "#d95f02",
                                "IEC" = "#7570b3", "WESC1" = "#e7298a",
                                "WESC2" = "#66a61e"))
# Create a legend plot
phos_legend <- get_legend(
  ggplot(estuary_wq_phos %>% filter(Date >= "2007-08-30")) +
  geom_point(aes(x = Date, y = Phosphate, color = Site.Name)) +
    scale_color_manual(values = c("ES1" = "#1b9e77","ES2" = "#d95f02",
                                "IEC" = "#7570b3", "WESC1" = "#e7298a",
                                "WESC2" = "#66a61e")) +
    labs(color = "Site"))

# Create a window for the before and after plots
phos_plot <- plot_grid(phos_before_plot, phos_after_plot)

# Create a window for the title
phos_title <- ggplot() + 
  labs(title = "Phosphate concentrations") +
  theme(plot.subtitle = element_text(hjust = 0.5))

# Generate the final plot with title, data, and legend
phos_plot_legend <- plot_grid(phos_title, phos_plot, phos_legend, 
                                 nrow = 3, rel_heights = c(0.1, 0.8, 0.1))
# Display plot
phos_plot_legend
```

# Salinity

``` {r fig.cap = "Measured salinity [units] before and after dam removal"}
# Create a before plot
salinity_before_plot <- ggplot(estuary_wq_salinity %>% filter(Date <= "2007-08-30")) +
  geom_point(aes(x = Date, y = Salinity, color = Site.Name)) +
  geom_line(aes(x = Date, y = Salinity, color = Site.Name), linewidth = 0.75) +
  scale_x_date(limits = c(as.Date("2006-06-01"), as.Date("2007-09-01")),
               breaks = "3 month", date_labels = "%b %Y") +
  ylim(c(0,0.75)) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position = "none") +
  labs(x = NULL, y = expression(paste("Salinity [units]"))) +
  scale_color_manual(values = c("ES1" = "#1b9e77", "ES2" = "#d95f02"))

# Create an after plot
salinity_after_plot <- ggplot(estuary_wq_salinity %>% filter(Date > "2007-08-30")) +
  geom_point(aes(x = Date, y = Salinity, color = Site.Name)) +
  geom_line(aes(x = Date, y = Salinity, color = Site.Name), linewidth = 0.75) +
  scale_x_date(limits = c(as.Date("2013-06-28"), as.Date("2014-10-12")),
               breaks = "3 month", date_labels = "%b %Y") +
  ylim(c(0,0.75)) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1), legend.position = "none") +
  labs(x = NULL, y = NULL) +
  scale_color_manual(values = c("ES1" = "#1b9e77","ES2" = "#d95f02",
                                "IEC" = "#7570b3", "WESC1" = "#e7298a",
                                "WESC2" = "#66a61e"))
# Create a legend plot
salinity_legend <- get_legend(
  ggplot(estuary_wq_salinity %>% filter(Date >= "2007-08-30")) +
  geom_point(aes(x = Date, y = Salinity, color = Site.Name)) +
    scale_color_manual(values = c("ES1" = "#1b9e77","ES2" = "#d95f02",
                                "IEC" = "#7570b3", "WESC1" = "#e7298a",
                                "WESC2" = "#66a61e")) +
    labs(color = "Site"))

# Create a window for the before and after plots
salinity_plot <- plot_grid(salinity_before_plot, salinity_after_plot)

# Create a window for the title
salinity_title <- ggplot() + 
  labs(title = "Salinity") +
  theme(plot.subtitle = element_text(hjust = 0.5))

# Generate the final plot with title, data, and legend
salinity_plot_legend <- plot_grid(salinity_title, salinity_plot, salinity_legend, 
                                 nrow = 3, rel_heights = c(0.1, 0.8, 0.1))
# Display plot
salinity_plot_legend
```

# Temperature

``` {r fig.cap = "Measured temperature [units] before and after dam removal"}
# Create a before plot
temp_before_plot <- ggplot(estuary_wq_temperature %>% filter(Date <= "2007-08-30")) +
  geom_point(aes(x = Date, y = Temperature, color = Site.Name)) +
  geom_line(aes(x = Date, y = Temperature, color = Site.Name), linewidth = 0.75) +
  scale_x_date(limits = c(as.Date("2006-06-01"), as.Date("2007-09-01")),
               breaks = "3 month", date_labels = "%b %Y") +
  ylim(c(0,15)) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position = "none") +
  labs(x = NULL, y = expression(paste("Salinity [units]"))) +
  scale_color_manual(values = c("ES1" = "#1b9e77", "ES2" = "#d95f02"))

# Create an after plot
temp_after_plot <- ggplot(estuary_wq_temperature %>% filter(Date > "2007-08-30")) +
  geom_point(aes(x = Date, y = Temperature, color = Site.Name)) +
  geom_line(aes(x = Date, y = Temperature, color = Site.Name), linewidth = 0.75) +
  scale_x_date(limits = c(as.Date("2013-06-28"), as.Date("2014-10-12")),
               breaks = "3 month", date_labels = "%b %Y") +
  ylim(c(0,15)) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1), legend.position = "none") +
  labs(x = NULL, y = NULL) +
  scale_color_manual(values = c("ES1" = "#1b9e77","ES2" = "#d95f02",
                                "IEC" = "#7570b3", "WESC1" = "#e7298a",
                                "WESC2" = "#66a61e"))
# Create a legend plot
temp_legend <- get_legend(
  ggplot(estuary_wq_temperature %>% filter(Date >= "2007-08-30")) +
  geom_point(aes(x = Date, y = Temperature, color = Site.Name)) +
    scale_color_manual(values = c("ES1" = "#1b9e77","ES2" = "#d95f02",
                                "IEC" = "#7570b3", "WESC1" = "#e7298a",
                                "WESC2" = "#66a61e")) +
    labs(color = "Site"))

# Create a window for the before and after plots
temp_plot <- plot_grid(temp_before_plot, temp_after_plot)

# Create a window for the title
temp_title <- ggplot() + 
  labs(title = "Temperature") +
  theme(plot.subtitle = element_text(hjust = 0.5))

# Generate the final plot with title, data, and legend
temp_plot_legend <- plot_grid(temp_title, temp_plot, temp_legend, 
                                 nrow = 3, rel_heights = c(0.1, 0.8, 0.1))
# Display plot
temp_plot_legend
```

# Dissolved oxygen

``` {r fig.cap = "Measured dissolved oxygen [units] before and after dam removal"}
# Create a before plot
do_before_plot <- ggplot(estuary_wq_do %>% filter(Date <= "2007-08-30")) +
  geom_point(aes(x = Date, y = Dissolved_Oxygen, color = Site.Name)) +
  geom_line(aes(x = Date, y = Dissolved_Oxygen, color = Site.Name), linewidth = 0.75) +
  scale_x_date(limits = c(as.Date("2006-06-01"), as.Date("2007-09-01")),
               breaks = "3 month", date_labels = "%b %Y") +
  ylim(c(0,15)) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position = "none") +
  labs(x = NULL, y = expression(paste("Dissolved Oxygen [units]"))) +
  scale_color_manual(values = c("ES1" = "#1b9e77", "ES2" = "#d95f02"))

# Create an after plot
do_after_plot <- ggplot(estuary_wq_do %>% filter(Date > "2007-08-30")) +
  geom_point(aes(x = Date, y = Dissolved_Oxygen, color = Site.Name)) +
  geom_line(aes(x = Date, y = Dissolved_Oxygen, color = Site.Name), linewidth = 0.75) +
  scale_x_date(limits = c(as.Date("2013-06-28"), as.Date("2014-10-12")),
               breaks = "3 month", date_labels = "%b %Y") +
  ylim(c(0,15)) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1), legend.position = "none") +
  labs(x = NULL, y = NULL) +
  scale_color_manual(values = c("ES1" = "#1b9e77","ES2" = "#d95f02",
                                "IEC" = "#7570b3", "WESC1" = "#e7298a",
                                "WESC2" = "#66a61e"))
# Create a legend plot
do_legend <- get_legend(
  ggplot(estuary_wq_do %>% filter(Date >= "2007-08-30")) +
  geom_point(aes(x = Date, y = Dissolved_Oxygen, color = Site.Name)) +
    scale_color_manual(values = c("ES1" = "#1b9e77","ES2" = "#d95f02",
                                "IEC" = "#7570b3", "WESC1" = "#e7298a",
                                "WESC2" = "#66a61e")) +
    labs(color = "Site"))

# Create a window for the before and after plots
do_plot <- plot_grid(do_before_plot, do_after_plot)

# Create a window for the title
do_title <- ggplot() + 
  labs(title = "Dissolved Oxygen") +
  theme(plot.subtitle = element_text(hjust = 0.5))

# Generate the final plot with title, data, and legend
do_plot_legend <- plot_grid(do_title, do_plot, do_legend, 
                                 nrow = 3, rel_heights = c(0.1, 0.8, 0.1))
# Display plot
do_plot_legend
```

# pH

``` {r fig.cap = "Measured pH [units] before and after dam removal"}
# Create a before plot
ph_before_plot <- ggplot(estuary_wq_ph %>% filter(Date <= "2007-08-30")) +
  geom_point(aes(x = Date, y = pH, color = Site.Name)) +
  geom_line(aes(x = Date, y = pH, color = Site.Name), linewidth = 0.75) +
  scale_x_date(limits = c(as.Date("2006-06-01"), as.Date("2007-09-01")),
               breaks = "3 month", date_labels = "%b %Y") +
  ylim(c(0,10)) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position = "none") +
  labs(x = NULL, y = expression(paste("Dissolved Oxygen [units]"))) +
  scale_color_manual(values = c("ES1" = "#1b9e77", "ES2" = "#d95f02"))

# Create an after plot
ph_after_plot <- ggplot(estuary_wq_ph %>% filter(Date > "2007-08-30")) +
  geom_point(aes(x = Date, y = pH, color = Site.Name)) +
  geom_line(aes(x = Date, y = pH, color = Site.Name), linewidth = 0.75) +
  scale_x_date(limits = c(as.Date("2013-06-28"), as.Date("2014-10-12")),
               breaks = "3 month", date_labels = "%b %Y") +
  ylim(c(0,10)) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1), legend.position = "none") +
  labs(x = NULL, y = NULL) +
  scale_color_manual(values = c("ES1" = "#1b9e77","ES2" = "#d95f02",
                                "IEC" = "#7570b3", "WESC1" = "#e7298a",
                                "WESC2" = "#66a61e"))
# Create a legend plot
ph_legend <- get_legend(
  ggplot(estuary_wq_ph %>% filter(Date >= "2007-08-30")) +
  geom_point(aes(x = Date, y = pH, color = Site.Name)) +
    scale_color_manual(values = c("ES1" = "#1b9e77","ES2" = "#d95f02",
                                "IEC" = "#7570b3", "WESC1" = "#e7298a",
                                "WESC2" = "#66a61e")) +
    labs(color = "Site"))

# Create a window for the before and after plots
ph_plot <- plot_grid(ph_before_plot, ph_after_plot)

# Create a window for the title
ph_title <- ggplot() + 
  labs(title = "pH") +
  theme(plot.subtitle = element_text(hjust = 0.5))

# Generate the final plot with title, data, and legend
ph_plot_legend <- plot_grid(ph_title, ph_plot, ph_legend, 
                                 nrow = 3, rel_heights = c(0.1, 0.8, 0.1))
# Display plot
ph_plot_legend
```

# Stacked plots

```{r fig.cap = "Water quality in the Elwha River estuary before and during dam removal"}

# Final water quality plot
estuary_wq_plot <- plot_grid(dataset_title,
                             nitrate_title, nitrate_plot,
                             phos_title, phos_plot,
                             temp_title, temp_plot,
                             do_title, do_plot,
                             ph_title, ph_plot,
                             estuary_wq_legend,
                             nrow = 12, rel_heights = c(2,1,7,1,7,1,7,1,7,1,7,1,7,1))
estuary_wq_plot
```



